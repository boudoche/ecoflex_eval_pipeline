<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Argusa Data Challenge - Submission</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      color: #111827; 
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    /* Argusa Header Banner */
    .header-banner {
      background: #004B87;
      padding: 2rem 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
    }
    .header-banner::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #004B87 0%, #004B87 25%, #FDB913 25%, #FDB913 50%, #000000 50%, #000000 75%, #E94E1B 75%, #E94E1B 100%);
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    .logo {
      height: 60px;
      width: auto;
    }
    .header-title {
      color: white;
      font-size: 1.75rem;
      font-weight: 500;
      font-family: 'Ubuntu', sans-serif;
    }
    
    /* Main Container */
    .container {
      max-width: 700px;
      margin: 3rem auto;
      padding: 0 2rem;
    }
    
    /* Token Input Box */
    .token-box {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      /* border-left: 4px solid #004B87; */
    }
    .token-box label {
      display: block;
      font-size: 0.95rem;
      font-weight: 600;
      color: #004B87;
      margin-bottom: 0.5rem;
    }
    .token-box input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .token-box input:focus {
      outline: none;
      border-color: #004B87;
    }
    
    /* Dropzone */
    .dropzone {
      background: white;
      border: 3px dashed #004B87;
      border-radius: 12px;
      padding: 3rem 2rem;
      text-align: center;
      color: #475569;
      transition: all 0.2s;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .dropzone:hover {
      border-color: #FDB913;
      background: #fffbf0;
    }
    .dropzone.dragover { 
      background: #e8f4ff; 
      border-color: #FDB913;
      transform: scale(1.02);
    }
    .dropzone-text {
      font-size: 1.1rem;
      color: #004B87;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .note { 
      margin-top: 0.75rem; 
      font-size: 0.95rem; 
      color: #6b7280; 
    }
    .link { 
      color: #E94E1B; 
      text-decoration: underline; 
      cursor: pointer;
      font-weight: 500;
    }
    .link:hover {
      color: #FDB913;
    }
    
    /* File List */
    .file-list { 
      display: flex; 
      justify-content: center; 
      gap: 0.5rem; 
      flex-wrap: wrap; 
      margin-top: 1.5rem; 
    }
    .file-chip { 
      display: inline-flex; 
      align-items: center; 
      gap: 0.5rem; 
      background: #004B87; 
      color: white;
      padding: 0.5rem 1rem; 
      border-radius: 9999px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      font-size: 0.95rem;
      font-weight: 500;
    }
    .file-dot { 
      width: 8px; 
      height: 8px; 
      background: #FDB913; 
      border-radius: 50%; 
    }
    .file-close { 
      width: 20px; 
      height: 20px; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      border-radius: 9999px; 
      background: rgba(255,255,255,0.2); 
      color: white; 
      cursor: pointer; 
      border: none;
      font-size: 16px; 
      line-height: 1;
      transition: background 0.2s;
    }
    .file-close:hover { 
      background: rgba(255,255,255,0.3); 
    }
    
    /* Messages */
    .msg { 
      margin-top: 1.5rem; 
      padding: 1rem 1.25rem; 
      border-radius: 10px; 
      font-weight: 500;
    }
    .ok { 
      background: #ecfdf5; 
      color: #065f46; 
      border: 2px solid #10b981; 
    }
    .err { 
      background: #fef2f2; 
      color: #991b1b; 
      border: 2px solid #ef4444; 
    }
    
    /* Submit Button */
    .submit-container {
      margin-top: 2rem;
      text-align: center;
    }
    button { 
      background: linear-gradient(135deg, #E94E1B 0%, #FDB913 100%);
      color: white; 
      border: 0; 
      padding: 1rem 3rem; 
      border-radius: 12px; 
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(233, 78, 27, 0.3);
      transition: all 0.2s;
    }
    button:hover:not(:disabled) { 
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(233, 78, 27, 0.4);
    }
    button:disabled { 
      background: #d1d5db; 
      cursor: not-allowed;
      box-shadow: none;
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Success Animation */
    .success-icon {
      display: inline-block;
      font-size: 2rem;
      animation: bounce 0.6s ease-out;
    }
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    .hidden { display: none; }
    input[type="file"] { display: none; }
  </style>
</head>
<body>
  <!-- Argusa Header Banner -->
  <div class="header-banner">
    <div class="header-content">
      <img src="assets/images/Argusa_Square.png" alt="Argusa" class="logo">
      <h1 class="header-title">Data Challenge - Submission Portal</h1>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <!-- Token Input -->
    <div class="token-box">
      <label for="token">Submission Token</label>
      <input id="token" type="text" placeholder="Paste your submission token here" autocomplete="off" />
    </div>

    <!-- Dropzone -->
    <div id="dropzone" class="dropzone">
      <div class="dropzone-text">üìÑ Drag & drop your JSON file here</div>
      <div class="note">or <span id="browse" class="link">browse to choose a file</span></div>
      <div id="fileList" class="file-list hidden"></div>
      <input id="fileInput" type="file" accept="application/json,.json" />
    </div>

    <!-- Message -->
    <div id="message" class="msg hidden"></div>

    <!-- Submit Button -->
    <div class="submit-container">
      <button id="submitBtn" disabled>Submit Answers</button>
    </div>
  </div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const browse = document.getElementById('browse');
    const submitBtn = document.getElementById('submitBtn');
    const message = document.getElementById('message');
    const tokenEl = document.getElementById('token');
    const fileList = document.getElementById('fileList');

    let payload = null;

    function showMessage(text, ok=true) {
      message.textContent = text;
      message.className = 'msg ' + (ok ? 'ok' : 'err');
    }

    function clearMessage() {
      message.textContent = '';
      message.className = 'msg hidden';
    }

    function clearFileSelection() {
      payload = null;
      submitBtn.disabled = true;
      fileInput.value = '';
      fileList.innerHTML = '';
      fileList.classList.add('hidden');
      showMessage('');
      clearMessage();
    }

    function showFileChip(name) {
      fileList.innerHTML = '';
      const chip = document.createElement('div');
      chip.className = 'file-chip';
      const dot = document.createElement('span');
      dot.className = 'file-dot';
      const text = document.createElement('span');
      text.textContent = name;
      const close = document.createElement('button');
      close.className = 'file-close';
      close.setAttribute('type', 'button');
      close.setAttribute('aria-label', 'Remove file');
      close.textContent = '√ó';
      close.addEventListener('click', (e) => {
        e.stopPropagation();
        clearFileSelection();
      });
      chip.appendChild(dot);
      chip.appendChild(text);
      chip.appendChild(close);
      fileList.appendChild(chip);
      fileList.classList.remove('hidden');
    }

    function handleFiles(files) {
      const file = files && files[0];
      if (!file) return;
      clearMessage();
      if (!file.name.endsWith('.json')) {
        showMessage('Please upload a .json file.', false);
        return;
      }
      // Check file size (5MB limit)
      const maxSize = 5 * 1024 * 1024; // 5MB in bytes
      if (file.size > maxSize) {
        showMessage(`File too large (${(file.size / (1024*1024)).toFixed(2)}MB). Maximum size: 5.0MB`, false);
        return;
      }
      showFileChip(file.name);
      const reader = new FileReader();
      reader.onload = () => {
        try {
          payload = JSON.parse(reader.result);
          submitBtn.disabled = false;
          showMessage('File ready to submit.');
        } catch (e) {
          showMessage('Invalid JSON file.', false);
        }
      };
      reader.readAsText(file);
    }

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    browse.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    submitBtn.addEventListener('click', async () => {
      if (!payload) return;
      clearMessage();
      const token = (tokenEl.value || '').trim();
      if (!token) { showMessage('Submission token is required.', false); return; }
      
      // Coerce payload shape: if it's an array, wrap as {answers: [...]}
      let bodyPayload = Array.isArray(payload) ? { answers: payload } : payload;
      
      // Disable button and show loading spinner
      submitBtn.disabled = true;
      const originalButtonText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="spinner"></span>Submitting...';
      
      // Show loading message
      message.innerHTML = '<span class="spinner"></span>Processing your submission...';
      message.className = 'msg ok';
      
      try {
        const params = new URLSearchParams({ use_llm: 'true', write_files: 'true' });
        const res = await fetch(`/grade?${params.toString()}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Submission-Token': token,
          },
          body: JSON.stringify(bodyPayload),
        });
        
        if (res.ok) {
          // Success! Show animated success message
          message.innerHTML = '<span class="success-icon">‚úÖ</span> <strong>Submission Complete!</strong><br><small>Your answers have been received and are being evaluated. You will receive a confirmation email shortly.</small>';
          message.className = 'msg ok';
          
          // Clear the form
          setTimeout(() => {
            clearFileSelection();
            tokenEl.value = '';
          }, 2000);
        } else if (res.status === 401) {
          showMessage('‚ùå Invalid or missing token. Please check your submission token.', false);
        } else if (res.status === 413) {
          let errText = '‚ùå Submission too large. Maximum size: 5.0MB';
          try {
            const data = await res.json();
            if (data && data.detail) errText = '‚ùå ' + data.detail;
          } catch {}
          showMessage(errText, false);
        } else {
          let errText = '‚ùå Submission failed. Please try again.';
          try {
            const data = await res.json();
            if (data && data.detail) errText = '‚ùå ' + data.detail;
          } catch {}
          showMessage(errText, false);
        }
      } catch (e) {
        showMessage('‚ùå Network error. Please check your connection and try again.', false);
      } finally {
        // Restore button
        submitBtn.innerHTML = originalButtonText;
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
